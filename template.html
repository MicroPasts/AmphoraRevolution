<link rel="stylesheet" href="http://ol3js.org/en/master/css/ol.css" type="text/css">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<style>
	#map {
		background-color: grey;
		border: 2px solid black;
	}
	.ol-zoom a, .ol-zoom-extent a, .ol-full-screen a {
		display: block;
		margin: 1px;
		padding: 0;
		color: white;
		font-size: 1.14em;
		font-weight: bold;
		text-decoration: none;
		text-align: center;
		height: 1.375em;
		width: 1.375em;
		line-height: 1.4em;
		background-color: #7b98bc;
		background-color: rgba(0,60,136,0.5);
		border: none;
	}
	.ol-zoom a::-moz-focus-inner, .ol-zoom-extent a::-moz-focus-inner, .ol-full-screen a::-moz-focus-inner {
		border: none;
		padding: 0;
	}
	.ol-zoom-extent a {
		line-height: 1.4em;
	}
	.ol-touch .ol-zoom a, .ol-touch .ol-full-screen a, .ol-touch .ol-zoom-extent a {
		font-size: 1.5em;
	}
	.ol-touch .ol-zoom-extent {
		top: 5.5em;
	}
	.ol-zoom a:hover, .ol-zoom a:focus, .ol-zoom-extent a:hover, .ol-zoom-extent a:focus, .ol-full-screen a:hover, .ol-full-screen a:focus {
		text-decoration: none;
		background-color: #4c6079;
		background-color: rgba(0,60,136,0.7);
	}
	.ol-zoom-extent a:after {
		content: "E";
	}
	.ol-zoom-in {
		border-radius: 2px 2px 0 0;
	}
	.ol-zoom-out {
		border-radius: 0 0 2px 2px;
	}
	a.ol-full-screen-false:after {
		content: "\2194";
	}
	a.ol-full-screen-true:after {
		content: "\00d7";
	}

	.ol-zoom-extent a, .ol-attribution, .ol-full-screen a, .ol-scale-line-inner, .ol-zoom a, .ol-has-tooltip [role=tooltip] {
		font-family: 'Lucida Grande', Verdana, Geneva, Lucida, Arial, Helvetica, sans-serif;
	}
</style>
<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
<script src="/static/js/vendor/ol3photomask.js" type="text/javascript"></script>
<style>
	.map {
		height: 500px;
		width: 100%;
	}
</style>

<!--
Task DOM for loading the S3 Images using class="skeleton" to identify the elements that belong to the task.
-->
<div class="row skeleton">
	<div class="col-md-12">

		<div class="btn-group pull-right">
			<button class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal">
				<i class="glyphicon glyphicon-eye-open"></i> Tutorial
			</button>
			<a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
		</div>
		<div id="step1">
			<h1>Step 1. Draw the scalebar and enter its length (in metres):</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Loading photo
				</button>
				<button id="scalebar" type="button" class="btn btn-default btn-type active" name="scalebar" value="scalebar">
					Scalebar
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div style="display:inline">
				Scale length:
				<input id="dimension" size="5" name="Scale length: ">
				</input>
			</div>
			<div class="btn-group">
				<button id="gotostep2" class="btn btn-success btn-next" value='gotostep2'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>

		<div id="step2" style="display:none;">
			<h1>Step 2. Draw the external profile of the vessel:</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="external" type="button" class="btn btn-default btn-type active" name="external" value="external">
					External
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep3" class="btn btn-success btn-next" value='gotostep3'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>

		<div id="step3" style="display:none;">
			<h1>Step 3. Draw the internal profile of the vessel:</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="internal" type="button" class="btn btn-default btn-type active" name="internal" value="internal">
					Internal
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep4" class="btn btn-success btn-next" value='gotostep4'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step4" style="display:none;">
			<h1>Step 4. Draw a mid-line box over one side of the vessel:</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="midline" type="button" class="btn btn-default btn-type active" name="midline" value="midline">
					Mid-Line
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep5" class="btn btn-success btn-next" value='gotostep5'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step5" style="display:none;">
			<h1>Step 5. Draw a box over the (approximate) neck-join of the vessel:</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="neckjoin" type="button" class="btn btn-default btn-type active" name="neckjoin" value="neckjoin">
					Neck-Join
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep6" class="btn btn-success btn-next" value='gotostep6'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step6" style="display:none;">
			<h1>Step 6. Draw the left-hand handles of the vessel (if shown):</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="lhandle" type="button" class="btn btn-default btn-type active" name="lhandle" value="lhandle">
					Left handle
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep7" class="btn btn-success btn-next" value='gotostep7'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step7" style="display:none;">
			<h1>Step 7. Draw the right-hand handle of the vessel (if shown):</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="rhandle" type="button" class="btn btn-default btn-type active" name="rhandle" value="rhandle">
					Right handle
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep8" class="btn btn-success btn-next" value='gotostep8'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step8" style="display:none;">
			<h1>Step 8. Draw the handle section (if shown):</h1>
			<div class="btn-group">
				<button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">
					Photo loaded
				</button>
				<button id="section" type="button" class="btn btn-default btn-type active" name="section" value="section">
					Handle section
				</button>
			</div>
			<div class="btn-group">
				<button id="draw" type="button" class="btn btn-default btn-draw active" name="draw" value="draw">
					Draw
				</button>
				<button id="edit" type="button" class="btn btn-default btn-draw" name="edit" value="edit">
					Edit
				</button>
				<button id="delete" type="button" class="btn btn-default btn-draw" name="delete" value="delete">
					Delete
				</button>
			</div>
			<div class="btn-group">
				<button id="gotostep9" class="btn btn-success btn-next" value='gotostep9'>
					<i class="icon icon-white icon-save"></i> Next
				</button>
			</div>
		</div>
		
		<div id="step9" style="display:none;">
			<h1>Step 9. Add any comments and submit:</h1>
        	<form id="comments" role="form">        
            	<div class="form-group">
                	<label class="control-label" for="transcription">Comments</label>
                	<textarea class="form-control" rows="5" name="comments" placeholder="(Add comments here or leave blank)"></textarea>
            	</div>
        	</form>
			<div class="btn-group">
				<button id="btn-save" class="btn btn-success btn-answer" value='save'>
					<i class="icon icon-white icon-save"></i> Submit All
				</button>
			</div>
		</div>
		
	</div>
</div>

<div class="row">
	<!-- Success and Error Messages for the user -->
	<div class="col-md-6 col-md-offset-2" style="height:50px">
		<div id="success" class="alert alert-success" style="display:none;">
			<a class="close">×</a>
			<strong>Well done!</strong> Your answer has been saved
		</div>
		<div id="loading" class="alert alert-info" style="display:none;">
			<a class="close">×</a>
			Loading next task...
		</div>
		<div id="taskcompleted" class="alert alert-info" style="display:none;">
			<strong>The task has been completed.</strong> Thanks a lot!
		</div>
		<div id="finish" class="alert alert-success" style="display:none;">
			<strong>Congratulations.</strong> You have participated in all available tasks!
			<br/>
			<div class="alert-actions">
				<a class="btn small" href="/">Go back</a>
				<a class="btn small" href="/app">or, Check other applications</a>
			</div>
		</div>
		<div id="error" class="alert alert-error" style="display:none;">
			<a class="close">×</a>
			<strong>Error!</strong> Something went wrong, please contact the site administrators
		</div>
	</div>
	<!-- End Success and Error Messages for the user -->
</div>
<!-- End of Row -->

<div class="row skeleton">
	<!-- Start Skeleton Row-->
	<div class="span8">
		<!-- Start of Photo DIV (column) -->
		<div id="map" class="img-polaroid"></div>
	</div><!-- End of Photo DIV (columnt) -->
	<div class="span4">
		<!-- Start of Question and Submission DIV (column) -->
		<!-- Feedback items for the user -->
		<p>
			You are working now on task: <span id="task-id" class="label label-warning">#</span>
		</p>
		<p>
			You have completed: <span id="done" class="label label-info"></span> tasks from <!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</p>
		<div class="progress progress-striped">
			<div id="progress" class="progress-bar" role="progressbar" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
		</div>

		<div id="answer">
			<!-- Start DIV for the submission buttons -->
		</div><!-- End of DIV for the submission buttons -->

	</div><!-- End of Question and Submission DIV (column) -->

</div><!-- End of Skeleton Row -->

<div id="survey" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title">Hey there! Do you want to help us?</h4>
			</div>
			<div class="modal-body">
				Thanks for contributing one task for the project. We are interested in knowing how you found out about us. <strong>Could you please answer two questions in a short survey?</strong>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1inhQxWP8zktNPf92CtClqpxT8C4hP2v4U-34PFkg9A0/viewform?embedded=true">Of course! Take me to the survey!</a>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="survey25" class="modal fade" data-backdrop="static">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title">Congrats for completing 25 tasks!</h4>
			</div>
			<div class="modal-body">
				Thanks for contributing 25 tasks for the project. Now that you have been using MicroPasts for a while, we would like to know how you found it. <strong>Could you please answer a few questions in a short survey?</strong>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					Skip
				</button>
				<a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1W0jj20-uKyO4c3pBoMcNWLoJk0uOjCZHXGENioP1FyY/viewform?embedded=true">Of course! Take me to the survey!</a>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h3><strong>Profile drawing tutorial for 3D modelling </strong></h3>
			</div>
			<div id="0" class="modal-body" style="display:none">
				<p>
					This application is very simple (but unfortunately does not yet work on mobile devices). When you participate, the platform will load a scanned drawing of an amphora such as the one below.
					These drawings are typical of how archaeologists traditionally record vessel shapes, with the outside of the vessel shown on one side of the drawing and the interior profile shown on the other side 
					(sometimes also with a further section showing the handle shape).
				</p>
				<p>	
					We are asking for help in digitising these drawings as 2D polygons that can then be used for futher analysis. These polygons also have the advantage of being ready for conversion into a 3D object.
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/intro.png" width="100%" class="img-polaroid" alt="An example of an amphora loaded into the application" />
			</div>
			<div id="1" class="modal-body" style="display:none">
				<p>
				Once the scanned drawing has been loaded, you will proceed in a series of steps as follows:
				<ul>
					<li>Calibrate the image's dimensions by drawing a line across the scale-bar shown in the drawing and entering its stated width in metres.</li>
					<li>Draw the external shape of the amphora as a polygon.</li>
					<li>Draw the interior of the amphora as two distinct polygons, one for the main cavity and another for neck portion.</li>
					<li>Draw a box around one half of the amphora where there is no profile information (which is useful for later processing)</li>
					<li>Draw the handles and handle section (if shown).</li>
				</ul>
				</p>
				<p>
					For most of the steps in each task, you will be asked to digitise a line or polygon by clicking along its outline. 
					To finish a line or polygon, double click on the last point you wish to enter. 
					If you are drawing a polygon, the last point your enter by double-clicking will automatically be joined  back up to the first point you created. 
					In each step of the task, a digitising toolbar provides options to draw, edit or delete features. 
					Once you have completed a stpe, you can  click 'Next' to proceed to the next part of the task.
					On the last step, you will no longer have a 'Next' button, but will notw see 'Submit all' that you can click to finsh your task. 
				</p>
			</div>
			<div id="2" class="modal-body" style="display:none">
				<p>
					How to use the application's digitising toolbar:
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/toolbar.png" width="50%" alt="Digitising Toolbar" />
				<p>
				<p>
					<strong>Photo loaded</strong>: This label simply indicates whether or not you are waiting for the scan to be loaded into the application.
					If it says 'Photo loaded', then you can begin digitising.
				</p>
				<p>
					<strong>Scalebar</strong>: This label indicates what part of the amphora you are currently digitising.
				</p>
				<p>
					<strong>Draw</strong>: This option is selected by default, at the beginning of a task. Click on 'Draw' whenever you want to start drawing a line or polygon. Once you complete your drawing of a feature, the delineating line will turn from blue to a different colour.
				</p>
				<p>
					<strong>Edit</strong>: This option is enabled once there is at least one complete feature drawn. After clicking on 'Edit', choose the line or polygon you wish to edit by clicking once anywhere on it. It will turn blue, and become available for editing such that you will be able to re-position the blue nodes that give the line its shape.
				</p>
				<p>
					<strong>Delete</strong>: Use this option if you wish to delete your existing drawing (for the current step only).
				</p>
				</p>
			</div>

			<div id="3" class="modal-body" style="display:none">
				<p>
					In step 1, you will be asked to draw a line from on end of the scale-bar shown in the drawing to the other.
				</p>
				<ul> 
				<li>
					Please only enter two points to create the line, not more!
				</li>
				<li>
					Once you have drawn the line, it will appear in green. Then please enter the stated width of the line in the box provided above the drawing.
				</li>
				<li>
					Please make sure you input this width in metres (so if the scalebar says 50cm, enter 0.5).
				</li>
				</ul>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/step1.png" width="80%" alt="Step 1 example" />
			</div>
			
			<div id="4" class="modal-body" style="display:none">
				<p>
					In step 2, you will be asked to draw a polygon outlining the external shape of the amphora.
					You line will be shown in yellow once you complete the sketch. 
					Around handle joins, you may need to guess how the oultine continues, 
					but your end result should look something like the one below.
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/step2.png" width="50%" alt="Step 2 example" />
			</div>
			
			<div id="5" class="modal-body" style="display:none">
				<p>
					In step 3, you will be asked to draw a polygon outlining the internal cavity of the amphora.
				</p>
				<p> 
					Your polygon outline will be shown in pink once you complete the sketch. Your focus will be on drawing the intrnal shape of the vessel as 
					shown on the left-hand side of the drawing, and your polygon should extend an arbitrary amount over the top of vessel and over the vessel mid-line 
					(it will be clipped accurately in post-processing). You finished polygon (overlayed on the results from the preivous steps) 
					should look something like the one below.
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/step3.png" width="50%" alt="Step 3 example" />
			</div>
			
			<div id="6" class="modal-body" style="display:none">
				<p>
					In steps 4 and 5, you will be asked to draw polygons outlining the non-profile portion of the drawing (the right-hand side in most cases) and the neck portion of the amphora.
					Your polygon for the vessel mid-line should delineate this mid-line exactly but then extend an arbitrary amount above, below and to the right of the vessel. 
					(it will be used for post-processing). Your polygon for the vessel neck-join should be a box in which the bottom side defines what you think to be the breakpoint between the main body of the vessel and its neck. 
					Sometimes this is hard to judge, but do your best.
					Your polygon outlines will be shown in orange and maroon respectively once you complete the sketches. 
					Your finished polygons (overlayed on the results from the preivous steps) 
					should look something like the ones below.
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/steps45.png" width="40%" alt="Steps 4-5 example" />
			</div>

			<div id="7" class="modal-body" style="display:none">
				<p>
					In steps 6 to 8, you will be asked to draw polygons outlining the left-hand handle, right-hand handle and handle sections, if these are shown.
					For the left and right handles, please make sure that you draw polygons that extend into the space between the external and internal profiles of the amphora, 
					as shown below (these will be clipped back in post-processing):
				</p>
				<img src="http://micropasts-other.s3.amazonaws.com/other/amphs1tut/steps678.png" width="40%" alt="Steps 6-8 example" />
			</div>
						
			<div id="8" class="modal-body" style="display:none">
				<p>
					In the last step, you will be asked if you wish to enter any of your own comments 
					(e.g. concerns you have about this drawing or notes about incomplete parts). Please keep these brief,
					as you can always post lengthier questions or comments on our <a href="http://community.micropasts.org" title="Community forum">community forum</a>.
				</p>
				<p>
					During the task, you can always return to this tutorial via the "Tutorial" button.
				</p>
			</div>

			<div class="modal-footer">
				<a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
				<a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
				<a id="startContrib" href="../amphs1/newtask" class="btn btn-primary" style="display:none"><i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
			</div>
		</div>
	</div>
</div>
<!-- Modal end -->
<script type="text/javascript">
	var step = -1;
	function showStep(action) {
		$("#" + step).hide();
		if (action == 'next') {
			step = step + 1;
		}
		if (action == 'prev') {
			step = step - 1;
		}
		if (step == 0) {
			$("#prevBtn").hide();
		} else {
			$("#prevBtn").show();
		}

		if (step == 8) {
			$("#nextBtn").hide();
			$("#startContrib").show();
		}
		$("#" + step).show();
	}

	showStep('next');
	$("#modal").modal('show'); 
</script>

<script>
function loadUserProgress() {
pybossa.userProgress('amphs1').done(function(data){

console.log('Tasks done so far: ' + data.done);

if ((data.done == 1) && ($.cookie('surveyAmphRev') === undefined)){
$("#survey").modal('show');
$.cookie('surveyAmphRev', 'shown', { path: '/'});
}
if ((data.done == 25) && ($.cookie('survey25AmphRev') === undefined)){
$("#survey25").modal('show');
$.cookie('survey25AmphRev', 'shown', { path: '/'});
}
var pct = Math.round((data.done*100)/data.total);
$("#progress").css("width", pct.toString() +"%");
$("#progress").attr("title", pct.toString() + "% completed!");
$("#progress").tooltip({'placement': 'left'});
$("#total").text(data.total);
$("#done").text(data.done);
});
}

pybossa.taskLoaded(function(task, deferred) {
if ( !$.isEmptyObject(task) ) {
// load image from flickr
var img = $('<img />');
var div_map = $('<div/>');
div_map.css("height", "500px");
div_map.css("width", "100%");
$("#draw").addClass("disabled");
$("#edit").addClass("disabled");
$("#delete").addClass("disabled");
$("#scalebar").addClass("disabled");
$("#map").append(div_map);
div_map.attr("id", "map_" + task.id);
img.load(function() {
// continue as soon as the image is loaded
deferred.resolve(task);
$("#draw").removeClass("disabled");
$("#edit").removeClass("disabled");
$("#delete").removeClass("disabled");
$("#scalebar").removeClass("disabled");
$("#status").text("Photo loaded");
});
img.attr('src', task.info.url_b).css('height', 100);

//Log the url of image being masked.
console.log(task.info.url_b);

img.addClass('img-polaroid');
task.info.image = img;

// Maps always need a projection, but the static image is not geo-referenced,
// and is only measured in pixels.  So, we create a fake projection that the
// map can use to properly display the layer.
task.pixelProjection = new ol.proj.Projection({
code: 'pixel',
units: 'pixels',
extent: [0, 0, 100, 100]
});

task.styleArray = [new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#ffcc33',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#ffcc33'
})
})
})];

task.source_scalebar = new ol.source.Vector();
task.source_external = new ol.source.Vector();
task.source_internal = new ol.source.Vector();
task.source_midline = new ol.source.Vector();
task.source_neckjoin = new ol.source.Vector();
task.source_lhandle = new ol.source.Vector();
task.source_rhandle = new ol.source.Vector();
task.source_section = new ol.source.Vector();

task.scalebar = new ol.layer.Vector({
source: task.source_scalebar,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#33ff55',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#33ff55'
})
})
})
});

task.external = new ol.layer.Vector({
source: task.source_external,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#ffcc33',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#ffcc33'
})
})
})
});

task.internal = new ol.layer.Vector({
source: task.source_internal,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#FF00FF',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#FF00FF'
})
})
})
});

task.midline = new ol.layer.Vector({
source: task.source_midline,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#FF7F50',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#FF7F50'
})
})
})
});

task.neckjoin = new ol.layer.Vector({
source: task.source_neckjoin,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#B22222',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#B22222'
})
})
})
});

task.lhandle = new ol.layer.Vector({
source: task.source_lhandle,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#800080',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#800080'
})
})
})
});

task.rhandle = new ol.layer.Vector({
source: task.source_rhandle,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#800080',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#800080'
})
})
})
});

task.section = new ol.layer.Vector({
source: task.source_section,
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: '#800000',
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: '#800000'
})
})
})
});

task.overlay = new ol.FeatureOverlay({
style: new ol.style.Style({
fill: new ol.style.Fill({
color: 'rgba(255, 255, 255, 0.2)'
}),
stroke: new ol.style.Stroke({
color: [0, 153, 255, 1],
width: 2
}),
image: new ol.style.Circle({
radius: 7,
fill: new ol.style.Fill({
color: [0, 153, 255, 1]
})
})
})
});

// Modifiers for scalebar
task.modify_scalebar = new ol.interaction.Modify({
layer: task.scalebar,
featureOverlay: task.overlay });
task.select_scalebar = new ol.interaction.Select({
layer: task.scalebar,
featureOverlay: task.overlay });
// Modifiers for external profile
task.modify_external = new ol.interaction.Modify({
layer: task.external,
featureOverlay: task.overlay });
task.select_external = new ol.interaction.Select({
layer: task.external,
featureOverlay: task.overlay });
// Modifiers for internal profile
task.modify_internal = new ol.interaction.Modify({
layer: task.internal,
featureOverlay: task.overlay });
task.select_internal = new ol.interaction.Select({
layer: task.internal,
featureOverlay: task.overlay });
// Modifiers for midline
task.modify_midline = new ol.interaction.Modify({
layer: task.midline,
featureOverlay: task.overlay });
task.select_midline = new ol.interaction.Select({
layer: task.midline,
featureOverlay: task.overlay });
// Modifiers for neckjoin
task.modify_neckjoin = new ol.interaction.Modify({
layer: task.neckjoin,
featureOverlay: task.overlay });
task.select_neckjoin = new ol.interaction.Select({
layer: task.neckjoin,
featureOverlay: task.overlay });
// Modifiers for left-hand handle
task.modify_lhandle = new ol.interaction.Modify({
layer: task.lhandle,
featureOverlay: task.overlay });
task.select_lhandle = new ol.interaction.Select({
layer: task.lhandle,
featureOverlay: task.overlay });
// Modifiers for right-hand handle
task.modify_rhandle = new ol.interaction.Modify({
layer: task.rhandle,
featureOverlay: task.overlay });
task.select_rhandle = new ol.interaction.Select({
layer: task.rhandle,
featureOverlay: task.overlay });
// Modifiers for handle section
task.modify_section = new ol.interaction.Modify({
layer: task.section,
featureOverlay: task.overlay });
task.select_section = new ol.interaction.Select({
layer: task.section,
featureOverlay: task.overlay });

// Set up map
task.map = new ol.Map({
interactions: ol.interaction.defaults().extend([select_scalebar, modify_scalebar]),
layers: [
new ol.layer.Image({
source: new ol.source.ImageStatic({
attributions: [
new ol.Attribution({
html: '&copy; <a href="http://micropasts.org">MicroPasts</a>'
})
],
url: task.info.url_b,
imageSize: [1000, 1000],
projection: task.pixelProjection,
imageExtent: task.pixelProjection.getExtent()
})
})
,
task.scalebar,
task.external,
task.internal,
task.midline,
task.neckjoin,
task.lhandle,
task.rhandle,
task.section,
],
renderer: 'canvas',
target: 'map_' + task.id,
view: new ol.View2D({
projection: task.pixelProjection,
center: ol.extent.getCenter(task.pixelProjection.getExtent()),
zoom: 1
})
});
var zoomslider;
zoomslider = new ol.control.ZoomSlider();
task.map.addControl(zoomslider);
div_map.css("display", "none");

var typeSelect = document.getElementById('type');

// Global task.draw so it can be removed later
task.draw_scalebar = new ol.interaction.Draw({
source: task.source_scalebar,
type: 'LineString',
});
task.draw_external = new ol.interaction.Draw({
source: task.source_external,
type: 'Polygon',
});
task.draw_internal = new ol.interaction.Draw({
source: task.source_internal,
type: 'Polygon',
});
task.draw_midline = new ol.interaction.Draw({
source: task.source_midline,
type: 'Polygon',
});
task.draw_neckjoin = new ol.interaction.Draw({
source: task.source_neckjoin,
type: 'Polygon',
});
task.draw_lhandle = new ol.interaction.Draw({
source: task.source_lhandle,
type: 'Polygon',
});
task.draw_rhandle = new ol.interaction.Draw({
source: task.source_rhandle,
type: 'Polygon',
});
task.draw_section = new ol.interaction.Draw({
source: task.source_section,
type: 'Polygon',
});

// When the first  polygon or line is completed, remove the drawInteraction
task.draw_scalebar.on('drawend', function(evt) {
task.scalebar = true;
});
task.draw_external.on('drawend', function(evt) {
task.external = true;
});
task.draw_internal.on('drawend', function(evt) {
task.internal = true;
});
task.draw_midline.on('drawend', function(evt) {
task.midline = true;
});
task.draw_neckjoin.on('drawend', function(evt) {
task.neckjoin = true;
});
task.draw_lhandle.on('drawend', function(evt) {
task.lhandle = true;
});
task.draw_rhandle.on('drawend', function(evt) {
task.rhandle = true;
});
task.draw_section.on('drawend', function(evt) {
task.section = true;
});

task.map.addInteraction(task.draw_scalebar);

task.answer = {
'task_id': task.id,
'scalebar': [],
'dimension': 0,
'external': [],
'internal': [],
'midline': [],
'neckjoin': [],
'lhandle': [],
'rhandle': [],
'section': [],
'comments': "None",
'img': task.info.url_b};
task.scalebar = false;
task.external = false;
task.internal = false;
task.midline = false;
task.neckjoin = false;
task.lhandle = false;
task.rhandle = false;
task.section = false;
}
else {
deferred.resolve(task);
}
});

pybossa.presentTask(function(task, deferred) {
if ( !$.isEmptyObject(task) ) {
loadUserProgress();
$("#step1").show();
$("#dimension").val("");
$(':input','#comments')
           .not(':button, :submit, :reset, :hidden, :radio')
           .val('');
$('#task-id').html(task.id);
$("#map_" + task.id).show();

// Code for drawing polygons and lines
$('.btn-draw').off('click').on('click', function(evt) {
var answer = $(evt.target).attr("value");
if (typeof answer != 'undefined'){
if (answer == 'draw') {
$("#edit").removeClass("active");
$("#delete").removeClass("active");
$("#draw").addClass("active");
if ($("#scalebar").hasClass("active")) {
task.map.removeInteraction(task.modify_scalebar);
task.map.removeInteraction(task.select_scalebar);
task.map.addInteraction(task.draw_scalebar);
} else if ($("#external").hasClass("active")) {
task.map.removeInteraction(task.modify_external);
task.map.removeInteraction(task.select_external);
task.map.addInteraction(task.draw_external);
} else if ($("#internal").hasClass("active")) {
task.map.removeInteraction(task.modify_internal);
task.map.removeInteraction(task.select_internal);
task.map.addInteraction(task.draw_internal);
} else if ($("#midline").hasClass("active")) {
task.map.removeInteraction(task.modify_midline);
task.map.removeInteraction(task.select_midline);
task.map.addInteraction(task.draw_midline);
} else if ($("#neckjoin").hasClass("active")) {
task.map.removeInteraction(task.modify_neckjoin);
task.map.removeInteraction(task.select_neckjoin);
task.map.addInteraction(task.draw_neckjoin);
} else if ($("#lhandle").hasClass("active")) {
task.map.removeInteraction(task.modify_lhandle);
task.map.removeInteraction(task.select_lhandle);
task.map.addInteraction(task.draw_lhandle);
} else if ($("#rhandle").hasClass("active")) {
task.map.removeInteraction(task.modify_rhandle);
task.map.removeInteraction(task.select_rhandle);
task.map.addInteraction(task.draw_rhandle);
} else {
task.map.removeInteraction(task.modify_section);
task.map.removeInteraction(task.select_section);
task.map.addInteraction(task.draw_section);
}

} else if (answer == 'edit') {
$("#draw").removeClass("active");
$("#delete").removeClass("active");
$("#edit").addClass("active");
if ($("#scalebar").hasClass("active")) {
task.map.removeInteraction(task.draw_scalebar);
task.map.addInteraction(task.select_scalebar);
task.map.addInteraction(task.modify_scalebar);
} else if ($("#external").hasClass("active")) {
task.map.removeInteraction(task.draw_external);
task.map.addInteraction(task.select_external);
task.map.addInteraction(task.modify_external);
} else if ($("#internal").hasClass("active")) {
task.map.removeInteraction(task.draw_internal);
task.map.addInteraction(task.select_internal);
task.map.addInteraction(task.modify_internal);
} else if ($("#midline").hasClass("active")) {
task.map.removeInteraction(task.draw_midline);
task.map.addInteraction(task.select_midline);
task.map.addInteraction(task.modify_midline);
} else if ($("#neckjoin").hasClass("active")) {
task.map.removeInteraction(task.draw_neckjoin);
task.map.addInteraction(task.select_neckjoin);
task.map.addInteraction(task.modify_neckjoin);
} else if ($("#lhandle").hasClass("active")) {
task.map.removeInteraction(task.draw_lhandle);
task.map.addInteraction(task.select_lhandle);
task.map.addInteraction(task.modify_lhandle);
} else if ($("#rhandle").hasClass("active")) {
task.map.removeInteraction(task.draw_rhandle);
task.map.addInteraction(task.select_rhandle);
task.map.addInteraction(task.modify_rhandle);
} else {
task.map.removeInteraction(task.draw_section);
task.map.addInteraction(task.select_section);
task.map.addInteraction(task.modify_section);
}

} else if (answer == 'delete') {
$("#draw").removeClass("active");
$("#edit").removeClass("active");
$("#delete").addClass("active");
if ($("#scalebar").hasClass("active")) {
var features = task.source_scalebar.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_scalebar.removeFeature(features[i]);
}
task.scalebar = false;
} else if ($("#external").hasClass("active")) {
var features = task.source_external.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_external.removeFeature(features[i]);
}
task.external = false;
} else if ($("#internal").hasClass("active")) {
var features = task.source_internal.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_internal.removeFeature(features[i]);
}
task.internal = false;
} else if ($("#midline").hasClass("active")) {
var features = task.source_midline.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_midline.removeFeature(features[i]);
}
task.midline = false;
} else if ($("#neckjoin").hasClass("active")) {
var features = task.source_neckjoin.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_neckjoin.removeFeature(features[i]);
}
task.neckjoin = false;
} else if ($("#lhandle").hasClass("active")) {
var features = task.source_lhandle.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_lhandle.removeFeature(features[i]);
}
task.lhandle = false;
} else if ($("#rhandle").hasClass("active")) {
var features = task.source_rhandle.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_rhandle.removeFeature(features[i]);
}
task.rhandle = false;
} else {
var features = task.source_section.getAllFeatures();
for(i=0;i<features.length;i++) {
task.source_section.removeFeature(features[i]);
}
task.section = false;
}
$("#draw").addClass("active");
$("#delete").removeClass("active");
}

}});

$('.btn-next').off('click').on('click', function(evt) {
var answer = $(evt.target).attr("value");
if (typeof answer != 'undefined'){

if (answer == 'gotostep2') {
$("#step1").toggle();
$("#step2").toggle();
$("#scalebar").removeClass("active");
$("#external").addClass("active");
task.map.removeInteraction(task.draw_scalebar);
task.map.addInteraction(task.draw_external);
} else if (answer == 'gotostep3') {
$("#external").removeClass("active");
$("#internal").addClass("active");
$("#step2").toggle();
$("#step3").toggle();
task.map.removeInteraction(task.draw_external);
task.map.addInteraction(task.draw_internal);
} else if (answer == 'gotostep4') {
$("#internal").removeClass("active");
$("#midline").addClass("active");
$("#step3").toggle();
$("#step4").toggle();
task.map.removeInteraction(task.draw_internal);
task.map.addInteraction(task.draw_midline);
} else if (answer == 'gotostep5') {
$("#midline").removeClass("active");
$("#neckjoin").addClass("active");
$("#step4").toggle();
$("#step5").toggle();
task.map.removeInteraction(task.draw_midline);
task.map.addInteraction(task.draw_neckjoin);
} else if (answer == 'gotostep6') {
$("#neckjoin").removeClass("active");
$("#lhandle").addClass("active");
$("#step5").toggle();
$("#step6").toggle();
task.map.removeInteraction(task.draw_neckjoin);
task.map.addInteraction(task.draw_lhandle);
} else if (answer == 'gotostep7') {
$("#lhandle").removeClass("active");
$("#rhandle").addClass("active");
$("#step6").toggle();
$("#step7").toggle();
task.map.removeInteraction(task.draw_lhandle);
task.map.addInteraction(task.draw_rhandle);
} else if (answer == 'gotostep8') {
$("#rhandle").removeClass("active");
$("#section").addClass("active");
$("#step7").toggle();
$("#step8").toggle();
task.map.removeInteraction(task.draw_rhandle);
task.map.addInteraction(task.draw_section);
} else {
$("#section").removeClass("active");
$("#comments").addClass("active");
$("#step8").toggle();
$("#step9").toggle();
task.map.removeInteraction(task.draw_section);
} 

}});

$('.btn-answer').off('click').on('click', function(evt) {
var answer = $(evt.target).attr("value");
if (typeof answer != 'undefined'){
//Log the answer submitted to console
console.log(answer);
//console.log(task.map.source.features);
//console.log(task.source.features);

if (task.scalebar) {
var features = task.source_scalebar.getAllFeatures();
var lines = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
lines.push(g.getCoordinates());
}
task.answer.scalebar = lines;
var dimension = parseFloat($("#dimension").val());
task.answer.dimension = dimension
} 
if (task.external) {
var features = task.source_external.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.external = polygons;
} 
if (task.internal) {
var features = task.source_internal.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.internal = polygons;
}
if (task.midline) {
var features = task.source_midline.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.midline = polygons;
}
if (task.neckjoin) {
var features = task.source_neckjoin.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.neckjoin = polygons;
} 
if (task.lhandle) {
var features = task.source_lhandle.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.lhandle = polygons;
}
if (task.rhandle) {
var features = task.source_rhandle.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.rhandle = polygons;
} 
if (task.section) {
var features = task.source_section.getAllFeatures();
var polygons = [];
for(i=0;i<features.length;i++) {
var g = features[i].getGeometry();
polygons.push(g.getCoordinates());
}
task.answer.section = polygons;
}
task.answer.comments = $('#comments :input').val();

pybossa.saveTask(task.id, task.answer).done(function() {
$("#success").fadeIn(500).fadeOut(5500);
deferred.resolve();
$("#step9").hide();
$("#map_" + task.id).remove();
});
$("#loading").fadeIn(500);

} else {
$("#error").show();
}
});
$("#loading").hide();
}
else {
$(".skeleton").hide();
$("#loading").hide();
$("#finish").fadeIn(500);
}
$('#imgLink').tooltip();

});

pybossa.run('amphs1');
</script>
